{% extends 'layouts/main.html' %}
{% block page_title %}Daily Medication Schedule - DiabetesEase{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Daily Medication Schedule</h1>
                <div>
                    <a href="{{ url_for('manage_medications') }}" class="btn btn-primary">Manage Medications</a>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <div id="errorAlert" style="display: none;" class="alert alert-danger">
                        <strong>Error:</strong>
                        <span id="errorMessage"></span>
                    </div>
                    <div id="daily-schedule">
                        <div class="text-center" id="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.medication-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
    background-color: white;
}

.medication-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.time-badge {
    background-color: #1cb3c7;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    font-weight: bold;
    min-width: 100px;
    text-align: center;
    margin-right: 1rem;
}

.medication-details {
    flex-grow: 1;
}

.medication-details h4 {
    margin: 0;
    color: #333;
    font-size: 1.1rem;
}

.medication-details p {
    margin: 0.25rem 0 0;
    color: #666;
}

#loading-spinner {
    padding: 2rem;
    text-align: center;
}

.medication-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-taken {
    padding: 0.375rem 0.75rem;
    border-radius: 0.25rem;
    background-color: #7ac58c;
    color: white;
    border: none;
    transition: background-color 0.2s;
}

.btn-taken:hover {
    background-color: #23883b;
}

.btn-not-taken {
    padding: 0.375rem 0.75rem;
    border-radius: 0.25rem;
    background-color: #23883b;
    color: white;
    border: none;
    transition: background-color 0.2s;
}

.btn-not-taken:hover {
    background-color: #2fb24d;
}

.medication-item.taken {
    background-color: #f8f9fa;
}

.medication-item.taken .time-badge {
    background-color: #8ed8e2
}
</style>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const scheduleContainer = document.getElementById('daily-schedule');
    const loadingSpinner = document.getElementById('loading-spinner');
    const errorAlert = document.getElementById('errorAlert');
    const errorMessage = document.getElementById('errorMessage');

    async function fetchDailySchedule() {
        try {
            loadingSpinner.style.display = 'block';
            errorAlert.style.display = 'none';
            
            const response = await fetch('/medications/daily');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const medications = await response.json();
            displaySchedule(medications);
        } catch (error) {
            console.error('Error:', error);
            errorMessage.textContent = 'Failed to load medication schedule. Please try again later.';
            errorAlert.style.display = 'block';
        } finally {
            loadingSpinner.style.display = 'none';
        }
    }

    async function logMedication(medicationId, time, button) {
        try {
            const response = await fetch(`/medications/log/${medicationId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ time: time })
            });
            
            if (response.ok) {
                // Update button appearance directly instead of refreshing
                button.className = 'btn-taken';
                button.disabled = true;
                button.textContent = 'Taken ✓';
                button.closest('.medication-item').classList.add('taken');
            } else {
                const data = await response.json();
                alert(data.message || 'Failed to log medication');
            }
        } catch (error) {
            console.error('Error logging medication:', error);
            alert('Error logging medication');
        }
    }

    function displaySchedule(medications) {
        if (!Array.isArray(medications)) {
            errorMessage.textContent = 'Invalid data received from server';
            errorAlert.style.display = 'block';
            return;
        }

        if (medications.length === 0) {
            scheduleContainer.innerHTML = `
                <div class="alert alert-info">
                    No medications scheduled for today. 
                    <a href="{{ url_for('manage_medications') }}" class="alert-link">Add medications</a>
                </div>`;
            return;
        }

        const scheduleHtml = medications.map(med => `
            <div class="medication-item ${med.taken ? 'taken' : ''}">
                <div class="time-badge">${med.time}</div>
                <div class="medication-details">
                    <h4>${med.name}</h4>
                    <p>${med.dosage}</p>
                </div>
                <div class="medication-actions">
                    <button 
                        onclick="logMedication(${med.id}, '${med.time}', this)"
                        class="${med.taken ? 'btn-taken' : 'btn-not-taken'}"
                        ${med.taken ? 'disabled' : ''}>
                        ${med.taken ? 'Taken ✓' : 'Mark as Taken'}
                    </button>
                </div>
            </div>
        `).join('');

        scheduleContainer.innerHTML = scheduleHtml;
    }

    // Initial fetch
    fetchDailySchedule();
    
    // Make logMedication available globally
    window.logMedication = logMedication;
    
    // Request Notification Permission
    if (Notification.permission !== "granted") {
        Notification.requestPermission();
    }

    // Check for reminders every minute
    setInterval(async () => {
        try {
            const response = await fetch('/medications/check-reminders');
            const reminders = await response.json();
            
            if (reminders.length > 0) {
                if (Notification.permission === "granted") {
                    reminders.forEach(med => {
                        new Notification("Medication Reminder", {
                            body: `Time to take ${med.name} (${med.dosage})`
                        });
                    });
                }
            }
        } catch (error) {
            console.error('Error checking reminders:', error);
        }
    }, 60000);
});
</script>
{% endblock %}